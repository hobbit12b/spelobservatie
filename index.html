<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spelobservaties groep 1 2</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root{
      --bg:#0b1220;
      --muted:#9ca3af;
      --text:#f9fafb;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --good: rgba(34,197,94,.14);
      --goodLine: rgba(34,197,94,.55);
      --warn: rgba(245,158,11,.14);
      --warnLine: rgba(245,158,11,.55);
      --bad: rgba(239,68,68,.14);
      --badLine: rgba(239,68,68,.55);
      --line: rgba(255,255,255,.09);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, #111827 0%, var(--bg) 55%, #050a14 100%);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;
      line-height:1.35;
    }
    .wrap{max-width:980px; margin:0 auto; padding:18px 14px 90px}
    header{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      margin:8px 0 14px;
    }
    h1{font-size:18px; margin:0 0 4px}
    .sub{color:var(--muted); font-size:13px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border: 1px solid rgba(255,255,255,.07);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      margin:12px 0;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    select, textarea, input[type="text"]{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius: 14px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:12px 12px;
      border-radius: 14px;
      font-size:15px;
      cursor:pointer;
      min-height:44px;
    }
    button:active{transform: translateY(1px)}
    .primary{background: var(--good); border-color: rgba(34,197,94,.35)}
    .ghost{background: transparent}
    .danger{background: var(--bad); border-color: rgba(239,68,68,.35)}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:520px){ .grid2{grid-template-columns:1fr} }

    .q{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding:12px;
      margin:10px 0;
      background: rgba(255,255,255,.02);
    }
    .qtitle{font-size:15px; margin:0 0 10px}
    .small{font-size:12px; color:var(--muted)}
    .topnav{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(17,24,39,.92);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px; border-radius: 14px;
      color:var(--text); box-shadow: var(--shadow);
      display:none;
      max-width: 92vw;
      font-size:14px;
    }
    .hr{height:1px; background: rgba(255,255,255,.08); margin:12px 0}
    .footerActions{display:flex; gap:10px; flex-wrap:wrap}

    .optLetters{display:flex; gap:8px; flex-wrap:wrap}
    .optLetters button{
      flex: 0 0 auto;
      min-width: 46px;
      padding: 10px 10px;
      font-weight: 800;
      letter-spacing: .02em;
    }
    .optLetters button.on{
      border-color: var(--goodLine);
      background: var(--good);
    }

    .legend{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
    }
    .legend .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .legend .chip b{color: var(--text)}

    .statement{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      background: rgba(255,255,255,.02);
      margin:10px 0;
    }
    .starBtn{
      width:44px;
      min-width:44px;
      text-align:center;
      font-size:18px;
      padding:10px 0;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .starBtn.on{
      border-color: rgba(245,158,11,.55);
      background: rgba(245,158,11,.14);
    }
    .statementText{flex:1; font-size:14px; color: var(--text)}
    .statementMeta{font-size:12px; color: var(--muted); margin-top:6px}

    .reportBox{
      white-space:pre-wrap;
      font-size:15px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      background: rgba(255,255,255,.02);
      padding:12px;
    }

    .session{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      background: rgba(255,255,255,.02);
      padding:12px;
      margin:10px 0;
    }
    .session h4{margin:0 0 6px; font-size:14px}
    .session p{margin:0; color:var(--muted); font-size:13px}
    .pillRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill b{color:var(--text)}
    details summary{cursor:pointer; color: var(--text)}
    details{margin-top:10px}
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 12px;
      margin-top:10px;
      color: var(--muted);
      font-size:13px;
    }
    .kv div:nth-child(2n){text-align:right; color: var(--text)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Spelobservaties groep 1 2</h1>
        <div class="sub">Alle observaties blijven zichtbaar met datum, rapportzinnen worden onderbouwd met tellers</div>
      </div>
      <div class="topnav">
        <button class="ghost" id="btnSaveClass">Opslaan klas</button>
        <button class="ghost" id="btnOverview">Overzicht</button>
        <button class="ghost" id="btnExport">Export</button>
        <button class="ghost" id="btnImport">Import</button>
      </div>
    </header>

    <div class="card">
      <div class="row">
        <div>
          <label>Leerling</label>
          <select id="studentSelect"></select>
          <div class="small" id="studentHint"></div>
        </div>
        <div>
          <label>Actie</label>
          <div class="btnbar">
            <button class="primary" id="btnNew">Nieuwe observatie</button>
            <button id="btnReport">Rapport maken</button>
          </div>
          <div class="small">Elke keer Opslaan maakt een nieuwe observatie aan met datum en tijd</div>
        </div>
      </div>
    </div>

    <div class="card" id="placeCard" style="display:none;">
      <label>Waar speelt of werkt de leerling nu</label>
      <div class="grid2" id="placeButtons"></div>
      <div class="hr"></div>
      <div class="small">Legenda antwoorden</div>
      <div class="legend" aria-label="Legenda">
        <div class="chip"><b>A</b> altijd</div>
        <div class="chip"><b>V</b> vaak</div>
        <div class="chip"><b>S</b> soms</div>
        <div class="chip"><b>Z</b> zelden</div>
        <div class="chip"><b>N</b> nee</div>
        <div class="chip"><b>?</b> weet ik niet</div>
      </div>
    </div>

    <div class="card" id="questionsCard" style="display:none;">
      <div class="row" style="align-items:center;">
        <div>
          <div class="small">Leerling</div>
          <div id="whoNow" style="font-size:16px; font-weight:800;"></div>
        </div>
        <div style="text-align:right;">
          <div class="small">Plek</div>
          <div id="placeNow" style="font-size:16px; font-weight:800;"></div>
        </div>
      </div>
      <div class="hr"></div>

      <div id="questions"></div>

      <div class="hr"></div>
      <label>Eigen notitie, optioneel</label>
      <textarea id="freeNote" placeholder="Typ kort en concreet wat je zag"></textarea>

      <div class="hr"></div>
      <div class="footerActions">
        <button class="primary" id="btnSave">Opslaan</button>
        <button id="btnCancel">Annuleren</button>
      </div>
      <div class="small">Opslaan maakt een nieuwe observatie aan, de tellerlaag wordt automatisch bijgewerkt</div>
    </div>

    <div class="card" id="reportCard" style="display:none;">
      <div class="row" style="align-items:flex-start;">
        <div>
          <div class="small">Rapport maken</div>
          <div style="font-size:16px; font-weight:900;" id="reportTitle"></div>
          <div class="small">Kies stellingen die je terug wilt zien, tik op de ster</div>
        </div>
        <div style="text-align:right;">
          <button class="primary" id="btnMakeTexts">Maak teksten</button>
          <button id="btnCopy">Kopieer</button>
        </div>
      </div>

      <div class="hr"></div>
      <div id="statementsWrap"></div>

      <div class="hr"></div>
      <label>Eigen stelling, optioneel</label>
      <input type="text" id="customStatement" placeholder="Voorbeeld: In de bouwhoek maakt zij graag een huis met poppetjes" />
      <div class="btnbar" style="margin-top:10px;">
        <button id="btnAddStatement">Voeg toe</button>
      </div>

      <div class="hr"></div>
      <div class="small">Teksten verschijnen hieronder</div>
      <div class="reportBox" id="reportText"></div>
    </div>

    <div class="card" id="overviewCard" style="display:none;">
      <div class="row" style="align-items:center;">
        <div>
          <div style="font-size:16px; font-weight:900;">Overzicht observaties</div>
          <div class="small" id="overviewSub"></div>
        </div>
        <div style="text-align:right;">
          <button class="danger" id="btnDeleteStudent">Verwijder data van leerling</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="sessions"></div>
    </div>

    <input type="file" id="importFile" accept="application/json" style="display:none;" />
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  const STUDENTS = [
    "ilsa","maria","senior","lisemarijn","zoëy","sammy","juliuscesar","danior","bodelijn","luukas",
    "samueg","juliana","lotty","milous","emilia","emmaheesters","jayke","lucas","meester","veranda","joëllaria"
  ];

  const PLACES = [
    { id:"woonhoek", label:"Woonhoek" },
    { id:"buiten", label:"Buiten" },
    { id:"bouwhoek", label:"Bouwhoek" },
    { id:"constructie", label:"Constructiemateriaal" },
    { id:"werkjes", label:"Werkjes uit de kast" }
  ];

  const SCALE = [
    { key:"altijd", letter:"A", label:"altijd" },
    { key:"vaak", letter:"V", label:"vaak" },
    { key:"soms", letter:"S", label:"soms" },
    { key:"zelden", letter:"Z", label:"zelden" },
    { key:"nee", letter:"N", label:"nee" },
    { key:"?", letter:"?", label:"weet ik niet" }
  ];

  const BASE_QUESTIONS = [
    { id:"start", text:"Start zelfstandig met spel of werk", type:"scale", dim:"initiatief" },
    { id:"volhouden", text:"Blijft bij een spel of taak", type:"scale", dim:"volhouden" },
    { id:"samen", text:"Speelt of werkt samen met anderen", type:"scale", dim:"samenspel" },
    { id:"taal", text:"Gebruikt woorden om mee te doen of te sturen", type:"scale", dim:"taal" },
    { id:"afspraken", text:"Houdt afspraken vast, zoals delen, wachten, opruimen", type:"scale", dim:"afspraken" }
  ];

  const PLACE_QUESTIONS = {
    woonhoek: [
      { id:"rol", text:"Speelt een rol, bijvoorbeeld ouder, dokter, winkel", type:"scale", dim:"rollenspel" },
      { id:"rollenAfspraken", text:"Maakt afspraken over rollen en houdt die even vol", type:"scale", dim:"rollenspel" }
    ],
    buiten: [
      { id:"spelregelsBuiten", text:"Doet mee met spelregels buiten, bijvoorbeeld tik of balspel", type:"scale", dim:"spelregels" },
      { id:"sociaalBuiten", text:"Zoekt contact, nodigt uit, reageert passend", type:"scale", dim:"samenspel" }
    ],
    bouwhoek: [
      { id:"bouwenPlan", text:"Bouwt met een idee of bedoeling", type:"scale", dim:"bouwen" },
      { id:"bouwenDoorzetten", text:"Probeert opnieuw als iets niet lukt", type:"scale", dim:"doorzetten" }
    ],
    constructie: [
      { id:"constructieCreatief", text:"Combineert materialen op een eigen manier", type:"scale", dim:"creativiteit" },
      { id:"constructieOplossen", text:"Zoekt oplossingen bij problemen", type:"scale", dim:"probleemoplossing" }
    ],
    werkjes: [
      { id:"werkZelfstandig", text:"Pakt een werkje en gaat zelfstandig aan de slag", type:"scale", dim:"zelfstandig" },
      { id:"focus", text:"Blijft met aandacht bij de taak", type:"scale", dim:"focus" },
      { id:"afgeleid", text:"Raakt afgeleid tijdens het werk", type:"scale", dim:"afleiding" },
      { id:"rondlopen", text:"Gaat rondlopen tijdens het werk", type:"scale", dim:"afleiding" },
      { id:"kletsen", text:"Gaat kletsen tijdens het werk", type:"scale", dim:"afleiding" },
      { id:"waardoor", text:"Waardoor raakt de leerling afgeleid", type:"multi", options:[
        "klasgenoten","geluid in de klas","materiaal op tafel","eigen ideeën","vermoeidheid","onduidelijkheid over de taak"
      ], dim:"afleiding" },
      { id:"helptFocus", text:"Wat helpt om weer door te gaan", type:"multi", options:[
        "rustige plek","samen starten","korte uitleg","stapje voor stapje","taak kleiner maken","timer of afgesproken tijd"
      ], dim:"focus" }
    ]
  };

  const STORAGE_KEY = "spelObservatiesV5";
  const $ = (id) => document.getElementById(id);

  function nowISO(){ return new Date().toISOString(); }
  function fmtDate(iso){
    const d = new Date(iso);
    return d.toLocaleString("nl-NL", { dateStyle:"medium", timeStyle:"short" });
  }
  function titleCase(name){
    if(!name) return "";
    return name.charAt(0).toUpperCase() + name.slice(1);
  }
  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.style.display="none", 2200);
  }

  function blankStats(){
    const obj = {};
    for(const o of SCALE) obj[o.key] = 0;
    obj.total = 0;
    return obj;
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{ return JSON.parse(raw); }catch(e){}
    }
    const fresh = { version:5, students:{} };
    for(const s of STUDENTS){
      fresh.students[s] = {
        sessions:[],   // ALLE observaties met datum
        agg:{          // tellerlaag opgebouwd uit sessions
          updatedAt:null,
          lastPlace:null,
          stats:{},
          multiStats:{}
        },
        prefs:{ starred:{}, customStatements:[] }
      };
    }
    save(fresh);
    return fresh;
  }
  function save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

  let data = load();
  let currentStudent = STUDENTS[0];
  let currentPlace = null;
  let draftAnswers = {};
  let draftMulti = {};

  function ensureStudent(name){
    if(!data.students[name]){
      data.students[name] = { sessions:[], agg:{ updatedAt:null, lastPlace:null, stats:{}, multiStats:{} }, prefs:{ starred:{}, customStatements:[] } };
    }
    const s = data.students[name];
    if(!Array.isArray(s.sessions)) s.sessions = [];
    if(!s.agg) s.agg = { updatedAt:null, lastPlace:null, stats:{}, multiStats:{} };
    if(!s.agg.stats) s.agg.stats = {};
    if(!s.agg.multiStats) s.agg.multiStats = {};
    if(!s.prefs) s.prefs = { starred:{}, customStatements:[] };
    if(!s.prefs.starred) s.prefs.starred = {};
    if(!Array.isArray(s.prefs.customStatements)) s.prefs.customStatements = [];
  }

  function student(name){ ensureStudent(name); return data.students[name]; }
  function prefs(name){ ensureStudent(name); return data.students[name].prefs; }

  function allQuestionsForPlace(placeId){
    const extra = PLACE_QUESTIONS[placeId] || [];
    return [...BASE_QUESTIONS, ...extra];
  }

  function renderStudentSelect(){
    const sel = $("studentSelect");
    sel.innerHTML = "";
    const names = Object.keys(data.students).sort((a,b)=> a.localeCompare(b,"nl"));
    for(const n of names){
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = titleCase(n);
      sel.appendChild(opt);
    }
    sel.value = currentStudent;

    const st = student(currentStudent);
    const count = st.sessions.length;
    const upd = st.agg.updatedAt ? fmtDate(st.agg.updatedAt) : "nog niet";
    $("studentHint").textContent = `Observaties: ${count}, laatst bijgewerkt: ${upd}`;
  }

  function renderPlaceButtons(){
    const host = $("placeButtons");
    host.innerHTML = "";
    for(const p of PLACES){
      const b = document.createElement("button");
      b.textContent = p.label;
      b.onclick = ()=> startQuestions(p.id);
      host.appendChild(b);
    }
  }

  function renderQuestions(placeId){
    const qs = allQuestionsForPlace(placeId);
    const host = $("questions");
    host.innerHTML = "";

    for(const q of qs){
      const box = document.createElement("div");
      box.className = "q";

      const t = document.createElement("div");
      t.className = "qtitle";
      t.textContent = q.text;
      box.appendChild(t);

      if(q.type === "scale"){
        const opt = document.createElement("div");
        opt.className = "optLetters";

        for(const o of SCALE){
          const btn = document.createElement("button");
          btn.textContent = o.letter;
          btn.title = o.label;
          btn.className = (draftAnswers[q.id] === o.key) ? "on" : "";
          btn.onclick = ()=>{
            draftAnswers[q.id] = o.key;
            renderQuestions(placeId);
          };
          opt.appendChild(btn);
        }
        box.appendChild(opt);

        const hint = document.createElement("div");
        hint.className = "small";
        hint.textContent = "Tik een letter";
        box.appendChild(hint);
      }

      if(q.type === "multi"){
        const opt = document.createElement("div");
        opt.className = "optLetters";
        draftMulti[q.id] = draftMulti[q.id] || [];
        const selected = new Set(draftMulti[q.id]);

        const btnUnknown = document.createElement("button");
        btnUnknown.textContent = "?";
        btnUnknown.title = "weet ik niet";
        btnUnknown.className = selected.has("?") ? "on" : "";
        btnUnknown.onclick = ()=>{
          if(selected.has("?")){
            selected.delete("?");
          }else{
            selected.clear();
            selected.add("?");
          }
          draftMulti[q.id] = [...selected];
          renderQuestions(placeId);
        };
        opt.appendChild(btnUnknown);

        for(const o of q.options){
          const btn = document.createElement("button");
          btn.textContent = o.slice(0,1).toUpperCase();
          btn.title = o;
          btn.className = selected.has(o) ? "on" : "";
          btn.onclick = ()=>{
            if(selected.has("?")) selected.delete("?");
            if(selected.has(o)) selected.delete(o); else selected.add(o);
            draftMulti[q.id] = [...selected];
            renderQuestions(placeId);
          };
          opt.appendChild(btn);
        }
        box.appendChild(opt);

        const hint = document.createElement("div");
        hint.className = "small";
        hint.textContent = "Je kunt meerdere opties kiezen, druk op ? als je het niet weet";
        box.appendChild(hint);
      }

      host.appendChild(box);
    }
  }

  function startQuestions(placeId){
    currentPlace = placeId;
    draftAnswers = {};
    draftMulti = {};
    $("freeNote").value = "";

    $("whoNow").textContent = titleCase(currentStudent);
    const p = PLACES.find(x=>x.id===placeId);
    $("placeNow").textContent = p ? p.label : placeId;

    $("placeCard").style.display = "none";
    $("questionsCard").style.display = "block";
    $("reportCard").style.display = "none";
    $("overviewCard").style.display = "none";

    renderQuestions(placeId);
  }

  function showPlaces(){
    $("placeCard").style.display = "block";
    $("questionsCard").style.display = "none";
    $("reportCard").style.display = "none";
    $("overviewCard").style.display = "none";
  }

  function showReport(){
    $("reportTitle").textContent = titleCase(currentStudent);
    $("reportText").textContent = "";
    $("customStatement").value = "";

    $("reportCard").style.display = "block";
    $("placeCard").style.display = "none";
    $("questionsCard").style.display = "none";
    $("overviewCard").style.display = "none";

    renderStatements();
  }

  function showOverview(){
    const st = student(currentStudent);
    const sessions = st.sessions.slice().sort((a,b)=> b.at.localeCompare(a.at));
    $("overviewSub").textContent = `${titleCase(currentStudent)}, ${sessions.length} observaties`;
    const host = $("sessions");
    host.innerHTML = "";

    if(!sessions.length){
      host.innerHTML = `<div class="small">Nog geen observaties opgeslagen</div>`;
    }else{
      sessions.forEach((s, idx)=>{
        const placeLabel = PLACES.find(x=>x.id===s.place)?.label || s.place;

        const el = document.createElement("div");
        el.className = "session";

        const h = document.createElement("h4");
        h.textContent = `${fmtDate(s.at)}, ${placeLabel}`;

        const p = document.createElement("p");
        const note = (s.note || "").trim();
        p.textContent = note ? note : "Geen notitie";

        const pills = document.createElement("div");
        pills.className = "pillRow";

        const answered = Object.keys(s.answers || {}).length;
        const multi = Object.keys(s.multi || {}).length;

        const pill1 = document.createElement("div");
        pill1.className = "pill";
        pill1.innerHTML = `<b>${answered}</b> stellingen`;

        const pill2 = document.createElement("div");
        pill2.className = "pill";
        pill2.innerHTML = `<b>${multi}</b> multi`;

        pills.appendChild(pill1);
        pills.appendChild(pill2);

        const details = document.createElement("details");
        const summary = document.createElement("summary");
        summary.textContent = "Toon antwoorden";
        details.appendChild(summary);

        const kv = document.createElement("div");
        kv.className = "kv";

        const qs = allQuestionsForPlace(s.place);
        for(const q of qs){
          if(q.type === "scale"){
            const val = (s.answers || {})[q.id];
            if(!val) continue;
            const letter = SCALE.find(x=>x.key===val)?.letter || val;
            kv.appendChild(document.createElement("div")).textContent = q.text;
            kv.appendChild(document.createElement("div")).textContent = letter;
          }
          if(q.type === "multi"){
            const arr = (s.multi || {})[q.id];
            if(!arr || !arr.length) continue;
            kv.appendChild(document.createElement("div")).textContent = q.text;
            kv.appendChild(document.createElement("div")).textContent = arr.join(", ");
          }
        }

        details.appendChild(kv);

        const del = document.createElement("button");
        del.className = "danger";
        del.style.marginTop = "12px";
        del.textContent = "Verwijder observatie";
        del.onclick = ()=>{
          const st2 = student(currentStudent);
          st2.sessions = st2.sessions.filter(x => !(x.at===s.at && x.place===s.place));
          rebuildAgg(currentStudent);
          save(data);
          toast("Observatie verwijderd");
          renderStudentSelect();
          showOverview();
        };

        el.appendChild(h);
        el.appendChild(p);
        el.appendChild(pills);
        el.appendChild(details);
        el.appendChild(del);

        host.appendChild(el);
      });
    }

    $("overviewCard").style.display = "block";
    $("reportCard").style.display = "none";
    $("placeCard").style.display = "none";
    $("questionsCard").style.display = "none";
  }

  function updateStats(statsObj, qid, answerKey){
    if(!statsObj[qid]) statsObj[qid] = blankStats();
    if(statsObj[qid][answerKey] === undefined) statsObj[qid][answerKey] = 0;
    statsObj[qid][answerKey] += 1;
    statsObj[qid].total += 1;
  }

  function updateMultiStats(multiStatsObj, qid, options){
    if(!multiStatsObj[qid]) multiStatsObj[qid] = {};
    for(const o of options){
      if(o === "?") continue;
      if(multiStatsObj[qid][o] === undefined) multiStatsObj[qid][o] = 0;
      multiStatsObj[qid][o] += 1;
    }
  }

  function rebuildAgg(name){
    const st = student(name);
    st.agg = { updatedAt:null, lastPlace:null, stats:{}, multiStats:{} };
    const sessions = st.sessions.slice().sort((a,b)=> a.at.localeCompare(b.at));
    for(const s of sessions){
      for(const [qid, key] of Object.entries(s.answers || {})){
        if(!key) continue;
        updateStats(st.agg.stats, qid, key);
      }
      for(const [qid, arr] of Object.entries(s.multi || {})){
        if(!Array.isArray(arr) || !arr.length) continue;
        updateMultiStats(st.agg.multiStats, qid, arr);
      }
      st.agg.updatedAt = s.at;
      st.agg.lastPlace = s.place;
    }
  }

  function saveSession(){
    const placeId = currentPlace;
    if(!placeId) return;

    const note = ($("freeNote").value || "").trim();
    const session = {
      at: nowISO(),
      place: placeId,
      answers: {...draftAnswers},
      multi: {...draftMulti},
      note: note
    };

    const st = student(currentStudent);
    st.sessions.push(session);

    // Agg bijwerken op basis van deze nieuwe sessie
    st.agg.updatedAt = session.at;
    st.agg.lastPlace = placeId;
    for(const [qid, key] of Object.entries(session.answers || {})){
      if(!key) continue;
      updateStats(st.agg.stats, qid, key);
    }
    for(const [qid, arr] of Object.entries(session.multi || {})){
      if(!Array.isArray(arr) || !arr.length) continue;
      updateMultiStats(st.agg.multiStats, qid, arr);
    }

    save(data);
    renderStudentSelect();
    toast("Observatie opgeslagen");
    showPlaces();
  }

  function saveClass(){
    save(data);
    toast("Klas opgeslagen");
  }

  function exportData(){
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `spelobservaties_klas_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Export gedownload");
  }

  function importData(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(reader.result);
        if(!obj || !obj.students) throw new Error("Geen geldige data");
        data = obj;

        // safety, ensure structure
        for(const k of Object.keys(data.students)){
          ensureStudent(k);
          rebuildAgg(k);
        }
        save(data);

        currentStudent = Object.keys(data.students)[0] || STUDENTS[0];
        renderStudentSelect();
        toast("Import gelukt");
        showPlaces();
      }catch(e){
        toast("Import mislukt");
      }
    };
    reader.readAsText(file);
  }

  function deleteStudent(){
    if(!confirm(`Weet je zeker dat je alle data van ${titleCase(currentStudent)} wilt verwijderen`)) return;
    ensureStudent(currentStudent);
    data.students[currentStudent].sessions = [];
    data.students[currentStudent].agg = { updatedAt:null, lastPlace:null, stats:{}, multiStats:{} };
    data.students[currentStudent].prefs = { starred:{}, customStatements:[] };
    save(data);
    toast("Data verwijderd");
    renderStudentSelect();
    showOverview();
  }

  // Rapport analyse
  function freqLabelFromStats(stats){
    if(!stats || !stats.total) return null;
    const keys = ["altijd","vaak","soms","zelden","nee"];
    let best = null;
    let bestCount = -1;
    for(const k of keys){
      const c = stats[k] || 0;
      if(c > bestCount){
        bestCount = c;
        best = k;
      }
    }
    if(bestCount <= 0) return null;
    return best;
  }

  function topMultiFromStats(multiStats, topN){
    if(!multiStats) return [];
    const entries = Object.entries(multiStats).sort((a,b)=>b[1]-a[1]);
    return entries.slice(0, topN).map(([k])=>k);
  }

  function pickTopPlacesFromSessions(sessions){
    const count = {};
    for(const s of sessions){
      count[s.place] = (count[s.place] || 0) + 1;
    }
    return Object.entries(count)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,2)
      .map(([id])=> PLACES.find(p=>p.id===id)?.label || id);
  }

  function lastNotes(name, n=2){
    const st = student(name);
    const notes = st.sessions
      .filter(s => (s.note||"").trim())
      .sort((a,b)=> b.at.localeCompare(a.at))
      .slice(0,n)
      .map(s => ({ at:s.at, place:s.place, text:s.note.trim() }));
    return notes;
  }

  function deriveStatementsForStudent(name){
    const st = student(name);
    const agg = st.agg || { stats:{}, multiStats:{} };
    const n = titleCase(name);

    const statements = [];
    const sessions = st.sessions || [];

    const places = pickTopPlacesFromSessions(sessions.slice(-10));
    if(places.length){
      statements.push({ key:"place", text:`Ik zie ${n} regelmatig bij ${places.join(" en ")}.`, reason:"Interesse", suggested:true });
    }

    const core = [
      { q:"start", good:`${n} kiest vaak zelf een spel of werkje en start zelfstandig. Daar mogen we trots op zijn.`, mid:`${n} start soms zelf, en soms helpt een klein zetje.`, low:`${n} heeft nog hulp nodig om te kiezen en te starten.`, reason:"Starten", suggested:true },
      { q:"volhouden", good:`${n} blijft vaak bij een spel of taak en maakt het af. Zo knap om te zien.`, mid:`${n} houdt een spel of taak soms even vast, daarna wisselt het nog weleens.`, low:`${n} wisselt nog snel. Langer doorgaan komt stapje voor stapje.`, reason:"Volhouden", suggested:true },
      { q:"samen", good:`${n} speelt vaak samen en zoekt contact met andere kinderen.`, mid:`${n} speelt soms samen, en speelt ook graag even alleen of naast anderen.`, low:`${n} speelt nu vooral alleen of naast anderen. Samen afstemmen is nog lastig.`, reason:"Samen spelen", suggested:true },
      { q:"taal", good:`${n} gebruikt woorden om mee te doen en het spel of werk te sturen.`, mid:`${n} gebruikt soms woorden, en laat ook veel zien met doen en aanwijzen.`, low:`${n} laat vooral met doen zien wat hij of zij bedoelt. Woorden in het spel komen nog op gang.`, reason:"Taal", suggested:true },
      { q:"afspraken", good:`${n} houdt afspraken vaak vast, zoals delen, wachten en opruimen.`, mid:`${n} houdt afspraken soms goed vast. Soms is er nog herinnering nodig.`, low:`${n} heeft nog begeleiding nodig bij afspraken, zoals wachten en delen.`, reason:"Afspraken", suggested:true }
    ];

    for(const c of core){
      const f = freqLabelFromStats(agg.stats?.[c.q]);
      if(!f) continue;
      if(f === "altijd" || f === "vaak"){
        statements.push({ key:`${c.q}_good`, text:c.good, reason:c.reason, suggested:true });
      }else if(f === "soms"){
        statements.push({ key:`${c.q}_mid`, text:c.mid, reason:c.reason, suggested:true });
      }else{
        statements.push({ key:`${c.q}_low`, text:c.low, reason:c.reason, suggested:false });
      }
    }

    const rolF = freqLabelFromStats(agg.stats?.rol);
    if(rolF === "altijd" || rolF === "vaak"){
      statements.push({ key:"rol", text:`In de woonhoek zie ik dat ${n} een rol pakt en die even volhoudt.`, reason:"Woonhoek", suggested:false });
    }
    const bouwF = freqLabelFromStats(agg.stats?.bouwenPlan);
    if(bouwF === "altijd" || bouwF === "vaak"){
      statements.push({ key:"bouw", text:`In de bouwhoek zie ik dat ${n} bouwt met een idee en dingen probeert als iets niet lukt.`, reason:"Bouwhoek", suggested:false });
    }

    const focusF = freqLabelFromStats(agg.stats?.focus);
    if(focusF){
      if(focusF === "altijd" || focusF === "vaak"){
        statements.push({ key:"focus_good", text:`Bij werkjes uit de kast blijft ${n} vaak met aandacht bezig. Dat gaat steeds meer vanzelf.`, reason:"Focus", suggested:true });
      }else if(focusF === "soms"){
        statements.push({ key:"focus_mid", text:`Bij werkjes uit de kast lukt focus soms goed, en soms is er wat afleiding.`, reason:"Focus", suggested:true });
      }else{
        statements.push({ key:"focus_low", text:`Bij werkjes uit de kast is focus nog lastig. Dan helpt korte begeleiding.`, reason:"Focus", suggested:false });
      }
    }

    const aflF = freqLabelFromStats(agg.stats?.afgeleid);
    if(aflF){
      if(aflF === "altijd" || aflF === "vaak"){
        statements.push({ key:"afl_high", text:`Tijdens werkjes zie ik regelmatig afleiding, zoals rondlopen of kletsen tussendoor.`, reason:"Afleiding", suggested:true });
      }else if(aflF === "soms"){
        statements.push({ key:"afl_mid", text:`Tijdens werkjes is er soms afleiding, dan helpt een klein seintje.`, reason:"Afleiding", suggested:false });
      }
    }

    const causes = topMultiFromStats(agg.multiStats?.waardoor, 2);
    if(causes.length){
      statements.push({ key:"cause", text:`Afleiding lijkt soms te komen door ${causes.join(" en ")}.`, reason:"Afleiding", suggested:false });
    }

    const help = topMultiFromStats(agg.multiStats?.helptFocus, 2);
    if(help.length){
      statements.push({ key:"help", text:`Wat helpt om weer door te gaan is bijvoorbeeld: ${help.join(" en ")}.`, reason:"Wat helpt", suggested:true });
    }

    const ln = lastNotes(name, 2);
    if(ln.length){
      statements.push({ key:"note", text:`Ik zag bijvoorbeeld: ${ln[0].text}`, reason:`Notitie ${fmtDate(ln[0].at)}`, suggested:true });
      if(ln[1]){
        statements.push({ key:"note2", text:`Een ander moment viel op: ${ln[1].text}`, reason:`Notitie ${fmtDate(ln[1].at)}`, suggested:false });
      }
    }

    // Volgende stap op basis van minst gekozen positieve frequentie
    const rank = { altijd:4, vaak:3, soms:2, zelden:1, nee:0 };
    const candidates = ["start","volhouden","samen","taal","afspraken"]
      .map(q=>{
        const f = freqLabelFromStats(agg.stats?.[q]);
        return { q, f, score: f ? rank[f] : null };
      })
      .filter(x=>x.score !== null);

    if(candidates.length){
      candidates.sort((a,b)=>a.score-b.score);
      const g = candidates[0].q;
      const labelMap = {
        start:"starten en kiezen",
        volhouden:"volhouden",
        samen:"samen spelen",
        taal:"woorden gebruiken in spel",
        afspraken:"afspraken vasthouden"
      };
      statements.push({
        key:"next",
        text:`Een volgende stap die nu goed past: ${labelMap[g]}. We oefenen dat rustig door in de klas.`,
        reason:"Volgende stap",
        suggested:true
      });
    }

    if(!statements.length){
      statements.push({ key:"no_data", text:`Voor ${n} heb ik nog te weinig ingevuld om een goede rapporttekst te maken.`, reason:"Nog weinig data", suggested:true });
    }

    return statements;
  }

  function renderStatements(){
    const pr = prefs(currentStudent);
    const list = deriveStatementsForStudent(currentStudent);

    const custom = pr.customStatements || [];
    const customItems = custom.map((t, idx)=>({
      key:`custom_${idx}`,
      text:t,
      reason:"Eigen stelling",
      suggested:true
    }));

    const merged = [...list, ...customItems];

    for(const item of merged){
      if(pr.starred[item.key] === undefined){
        pr.starred[item.key] = !!item.suggested;
      }
    }
    save(data);

    const host = $("statementsWrap");
    host.innerHTML = "";

    merged.forEach(item=>{
      const row = document.createElement("div");
      row.className = "statement";

      const star = document.createElement("div");
      star.className = "starBtn" + (pr.starred[item.key] ? " on" : "");
      star.textContent = pr.starred[item.key] ? "★" : "☆";
      star.onclick = ()=>{
        pr.starred[item.key] = !pr.starred[item.key];
        save(data);
        renderStatements();
      };

      const text = document.createElement("div");
      text.className = "statementText";
      text.textContent = item.text;

      const meta = document.createElement("div");
      meta.className = "statementMeta";
      meta.textContent = item.reason;

      text.appendChild(meta);
      row.appendChild(star);
      row.appendChild(text);

      host.appendChild(row);
    });
  }

  function buildTexts(){
    const pr = prefs(currentStudent);

    const list = deriveStatementsForStudent(currentStudent).map(x=>({ key:x.key, text:x.text }));
    const custom = (pr.customStatements || []).map((t, idx)=>({ key:`custom_${idx}`, text:t }));
    const all = [...list, ...custom];

    const starred = all.filter(x => pr.starred && pr.starred[x.key]);
    const chosen = starred.length ? starred : all.slice(0, 7);

    const order = [
      "place",
      "start_good","start_mid","start_low",
      "volhouden_good","volhouden_mid","volhouden_low",
      "samen_good","samen_mid","samen_low",
      "taal_good","taal_mid","taal_low",
      "afspraken_good","afspraken_mid","afspraken_low",
      "rol","bouw",
      "focus_good","focus_mid","focus_low",
      "afl_high","afl_mid","cause","help",
      "note","note2",
      "next"
    ];
    const idxOf = (k)=> {
      const i = order.indexOf(k);
      return i === -1 ? 999 : i;
    };
    chosen.sort((a,b)=> idxOf(a.key) - idxOf(b.key));

    // Optie 1: warm en compact, nadruk op basis
    const o1 = [];
    const prefer1 = ["place","start_good","volhouden_good","samen_good","taal_good","afspraken_good","note"];
    for(const k of prefer1){
      const it = chosen.find(x=>x.key===k);
      if(it && !o1.includes(it.text)) o1.push(it.text);
      if(o1.length >= 6) break;
    }
    if(o1.length < 4){
      for(const it of chosen){
        if(o1.length >= 6) break;
        if(!o1.includes(it.text)) o1.push(it.text);
      }
    }
    const t1 = o1.join(" ");

    // Optie 2: vollediger en beschrijvend
    const o2 = [];
    for(const it of chosen){
      if(o2.length >= 10) break;
      o2.push(it.text);
    }
    const t2 = o2.join(" ");

    // Optie 3: compleet, inclusief wat helpt en volgende stap
    const o3 = [];
    for(const it of chosen){
      if(o3.length >= 12) break;
      o3.push(it.text);
    }
    const next = chosen.find(x=>x.key==="next");
    if(next && !o3.includes(next.text)) o3.push(next.text);
    const t3 = o3.join(" ");

    $("reportText").textContent =
      `Optie 1\n${t1}\n\n` +
      `Optie 2\n${t2}\n\n` +
      `Optie 3\n${t3}`;

    toast("Teksten gemaakt");
  }

  function addCustomStatement(){
    const txt = ($("customStatement").value || "").trim();
    if(!txt){
      toast("Typ eerst een stelling");
      return;
    }
    const pr = prefs(currentStudent);
    pr.customStatements.push(txt);
    pr.starred[`custom_${pr.customStatements.length - 1}`] = true;
    save(data);
    $("customStatement").value = "";
    renderStatements();
    toast("Toegevoegd");
  }

  function init(){
    renderPlaceButtons();
    renderStudentSelect();
    showPlaces();

    $("studentSelect").addEventListener("change", (e)=>{
      currentStudent = e.target.value;
      renderStudentSelect();
      showPlaces();
    });

    $("btnNew").onclick = ()=> showPlaces();
    $("btnCancel").onclick = ()=> showPlaces();
    $("btnSave").onclick = ()=> saveSession();

    $("btnReport").onclick = ()=> showReport();
    $("btnMakeTexts").onclick = ()=> buildTexts();
    $("btnAddStatement").onclick = ()=> addCustomStatement();

    $("btnCopy").onclick = async ()=>{
      const txt = $("reportText").textContent;
      if(!txt.trim()){
        toast("Maak eerst teksten");
        return;
      }
      try{
        await navigator.clipboard.writeText(txt);
        toast("Gekopieerd");
      }catch(e){
        toast("Kopiëren lukt niet, selecteer en kopieer handmatig");
      }
    };

    $("btnOverview").onclick = ()=> showOverview();
    $("btnDeleteStudent").onclick = ()=> deleteStudent();
    $("btnSaveClass").onclick = ()=> saveClass();

    $("btnExport").onclick = ()=> exportData();
    $("btnImport").onclick = ()=> $("importFile").click();
    $("importFile").addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if(f) importData(f);
      e.target.value = "";
    });
  }

  init();
})();
</script>
</body>
</html>