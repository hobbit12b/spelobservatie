<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spelobservaties groep 1 2</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root{
      --bg:#0b1220;
      --muted:#9ca3af;
      --text:#f9fafb;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --line: rgba(255,255,255,.09);
      --good: rgba(34,197,94,.14);
      --goodLine: rgba(34,197,94,.55);
      --warn: rgba(245,158,11,.14);
      --warnLine: rgba(245,158,11,.55);
      --bad: rgba(239,68,68,.14);
      --badLine: rgba(239,68,68,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, #111827 0%, var(--bg) 55%, #050a14 100%);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;
      line-height:1.35;
    }
    .wrap{max-width:980px; margin:0 auto; padding:18px 14px 90px}
    header{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      margin:8px 0 14px;
    }
    h1{font-size:18px; margin:0 0 4px}
    .sub{color:var(--muted); font-size:13px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border: 1px solid rgba(255,255,255,.07);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      margin:12px 0;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    select, textarea, input[type="text"]{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius: 14px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:12px 12px;
      border-radius: 14px;
      font-size:15px;
      cursor:pointer;
      min-height:44px;
    }
    button:active{transform: translateY(1px)}
    .primary{background: var(--good); border-color: rgba(34,197,94,.35)}
    .ghost{background: transparent}
    .danger{background: var(--bad); border-color: rgba(239,68,68,.35)}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:520px){ .grid2{grid-template-columns:1fr} }

    .q{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding:12px;
      margin:10px 0;
      background: rgba(255,255,255,.02);
    }
    .qtitle{font-size:15px; margin:0 0 10px}
    .small{font-size:12px; color:var(--muted)}
    .topnav{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(17,24,39,.92);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px; border-radius: 14px;
      color:var(--text); box-shadow: var(--shadow);
      display:none;
      max-width: 92vw;
      font-size:14px;
    }
    .hr{height:1px; background: rgba(255,255,255,.08); margin:12px 0}
    .footerActions{display:flex; gap:10px; flex-wrap:wrap}

    .optLetters{display:flex; gap:8px; flex-wrap:wrap}
    .optLetters button{
      flex: 0 0 auto;
      min-width: 46px;
      padding: 10px 10px;
      font-weight: 700;
      letter-spacing: .02em;
    }
    .optLetters button.on{
      border-color: var(--goodLine);
      background: var(--good);
    }
    .legend{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
    }
    .legend .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .legend .chip b{color: var(--text)}
    .session{
      padding:10px 0;
      border-top:1px solid rgba(255,255,255,.07);
    }
    .session:first-child{border-top:0}
    .session h4{margin:0 0 6px; font-size:14px}
    .session p{margin:0; color:var(--muted); font-size:13px}

    .statement{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      background: rgba(255,255,255,.02);
      margin:10px 0;
    }
    .starBtn{
      width:44px;
      min-width:44px;
      text-align:center;
      font-size:18px;
      padding:10px 0;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .starBtn.on{
      border-color: rgba(245,158,11,.55);
      background: rgba(245,158,11,.14);
    }
    .statementText{
      flex:1;
      font-size:14px;
      color: var(--text);
    }
    .statementMeta{
      font-size:12px;
      color: var(--muted);
      margin-top:6px;
    }
    .reportBox{
      white-space:pre-wrap;
      font-size:15px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      background: rgba(255,255,255,.02);
      padding:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Spelobservaties groep 1 2</h1>
        <div class="sub">Snel invullen, later aanvullen, rapportteksten op basis van jouw data, alles blijft op je telefoon</div>
      </div>
      <div class="topnav">
        <button class="ghost" id="btnOverview">Overzicht</button>
        <button class="ghost" id="btnExport">Export</button>
        <button class="ghost" id="btnImport">Import</button>
      </div>
    </header>

    <div class="card">
      <div class="row">
        <div>
          <label>Leerling</label>
          <select id="studentSelect"></select>
          <div class="small" id="studentHint"></div>
        </div>
        <div>
          <label>Actie</label>
          <div class="btnbar">
            <button class="primary" id="btnNew">Nieuwe observatie</button>
            <button id="btnReport">Rapport maken</button>
          </div>
          <div class="small">Tip: korte sessies verspreid over tijd geven de beste rapporttekst</div>
        </div>
      </div>
    </div>

    <div class="card" id="placeCard" style="display:none;">
      <label>Waar speelt of werkt de leerling nu</label>
      <div class="grid2" id="placeButtons"></div>
      <div class="hr"></div>
      <div class="small">Legenda antwoorden</div>
      <div class="legend" aria-label="Legenda">
        <div class="chip"><b>A</b> altijd</div>
        <div class="chip"><b>V</b> vaak</div>
        <div class="chip"><b>S</b> soms</div>
        <div class="chip"><b>Z</b> zelden</div>
        <div class="chip"><b>N</b> nee</div>
        <div class="chip"><b>?</b> weet ik niet</div>
      </div>
    </div>

    <div class="card" id="questionsCard" style="display:none;">
      <div class="row" style="align-items:center;">
        <div>
          <div class="small">Leerling</div>
          <div id="whoNow" style="font-size:16px; font-weight:600;"></div>
        </div>
        <div style="text-align:right;">
          <div class="small">Plek</div>
          <div id="placeNow" style="font-size:16px; font-weight:600;"></div>
        </div>
      </div>
      <div class="hr"></div>

      <div id="questions"></div>

      <div class="hr"></div>
      <label>Eigen notitie (optioneel)</label>
      <textarea id="freeNote" placeholder="Typ hier jouw observatie, kort en concreet"></textarea>

      <div class="hr"></div>
      <div class="footerActions">
        <button class="primary" id="btnSave">Opslaan</button>
        <button id="btnCancel">Annuleren</button>
      </div>
      <div class="small">Alles wordt opgeslagen met datum en tijd</div>
    </div>

    <div class="card" id="reportCard" style="display:none;">
      <div class="row" style="align-items:flex-start;">
        <div>
          <div class="small">Rapport maken</div>
          <div style="font-size:16px; font-weight:700;" id="reportTitle"></div>
          <div class="small">Kies eerst wat je terug wilt zien, tik op de ster</div>
        </div>
        <div style="text-align:right;">
          <button class="primary" id="btnMakeTexts">Maak teksten</button>
          <button id="btnCopy">Kopieer</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="statementsWrap"></div>

      <div class="hr"></div>
      <label>Eigen stelling (optioneel)</label>
      <input type="text" id="customStatement" placeholder="Voorbeeld: In de bouwhoek maakt zij graag een huis met poppetjes" />
      <div class="btnbar" style="margin-top:10px;">
        <button id="btnAddStatement">Voeg toe</button>
      </div>

      <div class="hr"></div>
      <div class="small">Teksten verschijnen hieronder</div>
      <div class="reportBox" id="reportText"></div>
    </div>

    <div class="card" id="overviewCard" style="display:none;">
      <div class="row" style="align-items:center;">
        <div>
          <div style="font-size:16px; font-weight:700;">Overzicht observaties</div>
          <div class="small" id="overviewSub"></div>
        </div>
        <div style="text-align:right;">
          <button class="danger" id="btnDeleteStudent">Verwijder data van leerling</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="sessions"></div>
    </div>

    <input type="file" id="importFile" accept="application/json" style="display:none;" />
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  const STUDENTS = [
    "ilsa","maria","senior","lisemarijn","zoëy","sammy","juliuscesar","danior","bodelijn","luukas",
    "samueg","juliana","lotty","milous","emilia","emmaheesters","jayke","lucas","meester","veranda","joëllaria"
  ];

  const PLACES = [
    { id:"woonhoek", label:"Woonhoek" },
    { id:"buiten", label:"Buiten" },
    { id:"bouwhoek", label:"Bouwhoek" },
    { id:"constructie", label:"Constructiemateriaal" },
    { id:"werkjes", label:"Werkjes uit de kast" }
  ];

  // Volgorde zoals jij wilt
  const SCALE = [
    { key:"altijd", letter:"A", label:"altijd", score:4 },
    { key:"vaak", letter:"V", label:"vaak", score:3 },
    { key:"soms", letter:"S", label:"soms", score:2 },
    { key:"zelden", letter:"Z", label:"zelden", score:1 },
    { key:"nee", letter:"N", label:"nee", score:0 },
    { key:"?", letter:"?", label:"weet ik niet", score:null }
  ];

  const BASE_QUESTIONS = [
    { id:"start", text:"Start zelfstandig met spel of werk", type:"scale", dim:"initiatief" },
    { id:"volhouden", text:"Blijft bij een spel of taak", type:"scale", dim:"volhouden" },
    { id:"samen", text:"Speelt of werkt samen met anderen", type:"scale", dim:"samenspel" },
    { id:"taal", text:"Gebruikt woorden om mee te doen of te sturen", type:"scale", dim:"taal" },
    { id:"afspraken", text:"Houdt afspraken vast, zoals delen, wachten, opruimen", type:"scale", dim:"afspraken" }
  ];

  const PLACE_QUESTIONS = {
    woonhoek: [
      { id:"rol", text:"Speelt een rol, bijvoorbeeld ouder, dokter, winkel", type:"scale", dim:"rollenspel" },
      { id:"rollenAfspraken", text:"Maakt afspraken over rollen en houdt die even vol", type:"scale", dim:"rollenspel" }
    ],
    buiten: [
      { id:"spelregelsBuiten", text:"Doet mee met spelregels buiten, bijvoorbeeld tik of balspel", type:"scale", dim:"spelregels" },
      { id:"sociaalBuiten", text:"Zoekt contact, nodigt uit, reageert passend", type:"scale", dim:"samenspel" }
    ],
    bouwhoek: [
      { id:"bouwenPlan", text:"Bouwt met een idee of bedoeling", type:"scale", dim:"bouwen" },
      { id:"bouwenDoorzetten", text:"Probeert opnieuw als iets niet lukt", type:"scale", dim:"doorzetten" }
    ],
    constructie: [
      { id:"constructieCreatief", text:"Combineert materialen op een eigen manier", type:"scale", dim:"creativiteit" },
      { id:"constructieOplossen", text:"Zoekt oplossingen bij problemen", type:"scale", dim:"probleemoplossing" }
    ],
    werkjes: [
      { id:"werkZelfstandig", text:"Pakt een werkje en gaat zelfstandig aan de slag", type:"scale", dim:"zelfstandig" },
      { id:"focus", text:"Blijft met aandacht bij de taak", type:"scale", dim:"focus" },

      // Afleiding, hier betekent A of V juist vaker afleiding
      { id:"afgeleid", text:"Raakt afgeleid tijdens het werk", type:"scale", dim:"afleiding" },
      { id:"rondlopen", text:"Gaat rondlopen tijdens het werk", type:"scale", dim:"afleiding" },
      { id:"kletsen", text:"Gaat kletsen tijdens het werk", type:"scale", dim:"afleiding" },

      { id:"waardoor", text:"Waardoor raakt de leerling afgeleid", type:"multi", options:[
        "klasgenoten","geluid in de klas","materiaal op tafel","eigen ideeën","vermoeidheid","onduidelijkheid over de taak"
      ], dim:"afleiding" },

      { id:"helptFocus", text:"Wat helpt om weer door te gaan", type:"multi", options:[
        "rustige plek","samen starten","korte uitleg","stapje voor stapje","taak kleiner maken","timer of afgesproken tijd"
      ], dim:"focus" }
    ]
  };

  const STORAGE_KEY = "spelObservatiesV3";
  const $ = (id) => document.getElementById(id);

  function nowISO(){ return new Date().toISOString(); }
  function fmtDate(iso){
    const d = new Date(iso);
    return d.toLocaleString("nl-NL", { dateStyle:"medium", timeStyle:"short" });
  }
  function titleCase(name){
    if(!name) return "";
    return name.charAt(0).toUpperCase() + name.slice(1);
  }
  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.style.display="none", 2200);
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{ return JSON.parse(raw); }catch(e){}
    }
    const fresh = { version:3, students:{} };
    for(const s of STUDENTS){
      fresh.students[s] = { sessions:[], prefs:{ starred:{}, customStatements:[] } };
    }
    save(fresh);
    return fresh;
  }
  function save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

  let data = load();
  let currentStudent = STUDENTS[0];
  let currentPlace = null;
  let draftAnswers = {};
  let draftMulti = {};

  function ensureStudent(name){
    if(!data.students[name]) data.students[name] = { sessions:[], prefs:{ starred:{}, customStatements:[] } };
    if(!data.students[name].prefs) data.students[name].prefs = { starred:{}, customStatements:[] };
    if(!data.students[name].prefs.starred) data.students[name].prefs.starred = {};
    if(!Array.isArray(data.students[name].prefs.customStatements)) data.students[name].prefs.customStatements = [];
  }
  function studentSessions(name){
    ensureStudent(name);
    return data.students[name].sessions || [];
  }
  function prefs(name){
    ensureStudent(name);
    return data.students[name].prefs;
  }

  function renderStudentSelect(){
    const sel = $("studentSelect");
    sel.innerHTML = "";
    const names = Object.keys(data.students);
    names.sort((a,b)=> a.localeCompare(b,"nl"));
    for(const n of names){
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = titleCase(n);
      sel.appendChild(opt);
    }
    sel.value = currentStudent;
    $("studentHint").textContent = `${studentSessions(currentStudent).length} observaties opgeslagen`;
  }

  function renderPlaceButtons(){
    const host = $("placeButtons");
    host.innerHTML = "";
    for(const p of PLACES){
      const b = document.createElement("button");
      b.textContent = p.label;
      b.onclick = ()=> startQuestions(p.id);
      host.appendChild(b);
    }
  }

  function allQuestionsForPlace(placeId){
    const extra = PLACE_QUESTIONS[placeId] || [];
    return [...BASE_QUESTIONS, ...extra];
  }

  function renderQuestions(placeId){
    const qs = allQuestionsForPlace(placeId);
    const host = $("questions");
    host.innerHTML = "";

    for(const q of qs){
      const box = document.createElement("div");
      box.className = "q";

      const t = document.createElement("div");
      t.className = "qtitle";
      t.textContent = q.text;
      box.appendChild(t);

      if(q.type === "scale"){
        const opt = document.createElement("div");
        opt.className = "optLetters";

        for(const o of SCALE){
          const btn = document.createElement("button");
          btn.textContent = o.letter;
          btn.title = o.label;

          btn.className = (draftAnswers[q.id] === o.key) ? "on" : "";
          btn.onclick = ()=>{
            draftAnswers[q.id] = o.key;
            renderQuestions(placeId);
          };
          opt.appendChild(btn);
        }

        box.appendChild(opt);

        const hint = document.createElement("div");
        hint.className = "small";
        hint.textContent = "Tik een letter";
        box.appendChild(hint);
      }

      if(q.type === "multi"){
        const opt = document.createElement("div");
        opt.className = "optLetters";
        draftMulti[q.id] = draftMulti[q.id] || [];
        const selected = new Set(draftMulti[q.id]);

        const btnUnknown = document.createElement("button");
        btnUnknown.textContent = "?";
        btnUnknown.title = "weet ik niet";
        btnUnknown.className = selected.has("?") ? "on" : "";
        btnUnknown.onclick = ()=>{
          if(selected.has("?")){
            selected.delete("?");
          }else{
            selected.clear();
            selected.add("?");
          }
          draftMulti[q.id] = [...selected];
          renderQuestions(placeId);
        };
        opt.appendChild(btnUnknown);

        for(const o of q.options){
          const btn = document.createElement("button");
          btn.textContent = o.slice(0,1).toUpperCase();
          btn.title = o;

          btn.className = selected.has(o) ? "on" : "";
          btn.onclick = ()=>{
            if(selected.has("?")) selected.delete("?");
            if(selected.has(o)) selected.delete(o); else selected.add(o);
            draftMulti[q.id] = [...selected];
            renderQuestions(placeId);
          };
          opt.appendChild(btn);
        }
        box.appendChild(opt);

        const hint = document.createElement("div");
        hint.className = "small";
        hint.textContent = "Je kunt meerdere opties kiezen, druk op ? als je het niet weet";
        box.appendChild(hint);
      }

      host.appendChild(box);
    }
  }

  function startQuestions(placeId){
    currentPlace = placeId;
    draftAnswers = {};
    draftMulti = {};
    $("freeNote").value = "";

    $("whoNow").textContent = titleCase(currentStudent);
    const p = PLACES.find(x=>x.id===placeId);
    $("placeNow").textContent = p ? p.label : placeId;

    $("placeCard").style.display = "none";
    $("questionsCard").style.display = "block";
    $("reportCard").style.display = "none";
    $("overviewCard").style.display = "none";

    renderQuestions(placeId);
  }

  function showPlaces(){
    $("placeCard").style.display = "block";
    $("questionsCard").style.display = "none";
    $("reportCard").style.display = "none";
    $("overviewCard").style.display = "none";
  }

  function showReport(){
    $("reportTitle").textContent = titleCase(currentStudent);
    $("reportText").textContent = "";
    $("customStatement").value = "";

    $("reportCard").style.display = "block";
    $("placeCard").style.display = "none";
    $("questionsCard").style.display = "none";
    $("overviewCard").style.display = "none";

    renderStatements();
  }

  function showOverview(){
    const sessions = studentSessions(currentStudent).slice().reverse();
    $("overviewSub").textContent = `${titleCase(currentStudent)}, ${sessions.length} observaties`;
    const host = $("sessions");
    host.innerHTML = "";

    if(!sessions.length){
      host.innerHTML = `<div class="small">Nog geen observaties opgeslagen</div>`;
    }else{
      sessions.forEach((s)=>{
        const p = PLACES.find(x=>x.id===s.place);
        const el = document.createElement("div");
        el.className = "session";

        const title = document.createElement("h4");
        title.textContent = `${fmtDate(s.at)}, ${p ? p.label : s.place}`;

        const info = document.createElement("p");
        const ans = Object.values(s.answers||{});
        const known = ans.filter(x=>x && x !== "?").length;
        const unknown = ans.filter(x=>x === "?").length;
        const note = s.note && s.note.trim() ? `Notitie: ${s.note.trim()}` : "";
        info.textContent = `${known} antwoorden, ${unknown} keer vraagteken. ${note}`.trim();

        const del = document.createElement("button");
        del.className = "danger";
        del.style.marginTop = "10px";
        del.textContent = "Verwijder deze observatie";
        del.onclick = ()=>{
          const list = studentSessions(currentStudent);
          const idx = list.findIndex(x=>x.at===s.at && x.place===s.place);
          if(idx >= 0){
            list.splice(idx,1);
            save(data);
            toast("Observatie verwijderd");
            $("studentHint").textContent = `${studentSessions(currentStudent).length} observaties opgeslagen`;
            showOverview();
          }
        };

        el.appendChild(title);
        el.appendChild(info);
        el.appendChild(del);
        host.appendChild(el);
      });
    }

    $("overviewCard").style.display = "block";
    $("reportCard").style.display = "none";
    $("placeCard").style.display = "none";
    $("questionsCard").style.display = "none";
  }

  function saveSession(){
    const note = $("freeNote").value || "";
    const placeId = currentPlace;
    if(!placeId) return;

    ensureStudent(currentStudent);

    const session = {
      at: nowISO(),
      place: placeId,
      answers: {...draftAnswers},
      multi: {...draftMulti},
      note: note
    };

    data.students[currentStudent].sessions.push(session);
    save(data);

    $("studentHint").textContent = `${studentSessions(currentStudent).length} observaties opgeslagen`;
    toast("Opgeslagen");
    showPlaces();
  }

  // Helpers voor analyse
  const scoreByKey = Object.fromEntries(SCALE.map(x => [x.key, x.score]));
  function scoreOf(answerKey){
    if(answerKey === undefined || answerKey === null) return null;
    if(answerKey === "?") return null;
    if(scoreByKey[answerKey] === undefined) return null;
    return scoreByKey[answerKey];
  }

  function avgScore(values){
    const v = values.filter(x=>x !== null && x !== undefined);
    if(!v.length) return null;
    const sum = v.reduce((a,b)=>a+b,0);
    return sum / v.length;
  }

  function freqFromAvg(avg){
    // avg: 0..4
    if(avg === null) return "unknown";
    if(avg >= 3.5) return "altijd";
    if(avg >= 2.7) return "vaak";
    if(avg >= 1.7) return "soms";
    if(avg >= 0.7) return "zelden";
    return "nee";
  }

  function pickTopPlaces(sessions){
    const count = {};
    for(const s of sessions){
      count[s.place] = (count[s.place] || 0) + 1;
    }
    return Object.entries(count)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,2)
      .map(([id])=>{
        const p = PLACES.find(x=>x.id===id);
        return p ? p.label : id;
      });
  }

  function collectDimScores(sessions, dimKey){
    const scores = [];
    for(const s of sessions){
      const qs = allQuestionsForPlace(s.place);
      for(const q of qs){
        if(q.type !== "scale") continue;
        if(q.dim !== dimKey) continue;
        const a = (s.answers || {})[q.id];
        const sc = scoreOf(a);
        if(sc !== null) scores.push(sc);
      }
    }
    return scores;
  }

  function collectMulti(sessions, key){
    const out = [];
    for(const s of sessions){
      const arr = (s.multi || {})[key];
      if(Array.isArray(arr)) out.push(...arr.filter(x=>x && x !== "?"));
    }
    return out;
  }

  function topN(list, n){
    const count = {};
    for(const item of list) count[item] = (count[item]||0) + 1;
    return Object.entries(count).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([k])=>k);
  }

  function lastNote(sessions){
    const last = [...sessions].reverse().find(s => s.note && s.note.trim());
    return last ? last.note.trim() : "";
  }

  // Stellingen bouwen
  function deriveStatementsForStudent(name){
    const sessions = studentSessions(name);
    const n = titleCase(name);
    const last = sessions.slice(-10);

    if(!sessions.length){
      return [
        { key:"no_data", text:`Voor ${n} heb ik nog geen observaties opgeslagen.`, reason:"Nog geen data", suggested:true }
      ];
    }

    const places = pickTopPlaces(last);
    const placeText = places.length
      ? `Ik zie ${n} regelmatig bij ${places.join(" en ")}.`
      : `${n} laat in spel verschillende interesses zien.`;

    const initAvg = avgScore(collectDimScores(last, "initiatief"));
    const volAvg = avgScore(collectDimScores(last, "volhouden"));
    const samenAvg = avgScore(collectDimScores(last, "samenspel"));
    const taalAvg = avgScore(collectDimScores(last, "taal"));
    const afsAvg = avgScore(collectDimScores(last, "afspraken"));
    const rolAvg = avgScore(collectDimScores(last, "rollenspel"));
    const bouwAvg = avgScore(collectDimScores(last, "bouwen"));
    const focusAvg = avgScore(collectDimScores(last, "focus"));

    // Afleiding is anders: hoger betekent vaker afleiding
    const afleidingAvg = avgScore(collectDimScores(last, "afleiding"));

    const initF = freqFromAvg(initAvg);
    const volF = freqFromAvg(volAvg);
    const samenF = freqFromAvg(samenAvg);
    const taalF = freqFromAvg(taalAvg);
    const afsF = freqFromAvg(afsAvg);
    const rolF = freqFromAvg(rolAvg);
    const bouwF = freqFromAvg(bouwAvg);
    const focusF = freqFromAvg(focusAvg);
    const afleidF = freqFromAvg(afleidingAvg);

    const sawWork = last.some(s => s.place === "werkjes");
    const help = topN(collectMulti(last, "helptFocus"), 2);
    const causes = topN(collectMulti(last, "waardoor"), 2);
    const note = lastNote(last);

    const st = [];

    st.push({ key:"place", text:placeText, reason:"Interesse", suggested:true });

    // Initiatief
    if(initF === "altijd" || initF === "vaak"){
      st.push({ key:"init_good", text:`${n} kiest vaak zelf een spel of werkje en start zelfstandig. Daar zijn we trots op.`, reason:"Starten", suggested:true });
    }else if(initF === "soms"){
      st.push({ key:"init_mid", text:`${n} start soms zelf, en soms helpt een klein zetje.`, reason:"Starten", suggested:true });
    }else if(initF === "zelden" || initF === "nee"){
      st.push({ key:"init_low", text:`${n} heeft nog hulp nodig om te kiezen en te starten.`, reason:"Starten", suggested:true });
    }

    // Volhouden
    if(volF === "altijd" || volF === "vaak"){
      st.push({ key:"vol_good", text:`${n} blijft vaak bij een spel of taak en maakt het af. Zo knap om te zien.`, reason:"Volhouden", suggested:true });
    }else if(volF === "soms"){
      st.push({ key:"vol_mid", text:`${n} houdt een spel of taak soms even vast, daarna wisselt het nog weleens.`, reason:"Volhouden", suggested:true });
    }else if(volF === "zelden" || volF === "nee"){
      st.push({ key:"vol_low", text:`${n} wisselt nog snel. Langer doorgaan komt stapje voor stapje.`, reason:"Volhouden", suggested:false });
    }

    // Samen spelen
    if(samenF === "altijd" || samenF === "vaak"){
      st.push({ key:"sam_good", text:`${n} speelt vaak samen en zoekt contact met andere kinderen.`, reason:"Samen spelen", suggested:true });
    }else if(samenF === "soms"){
      st.push({ key:"sam_mid", text:`${n} speelt soms samen, en speelt ook graag even alleen of naast anderen.`, reason:"Samen spelen", suggested:true });
    }else if(samenF === "zelden" || samenF === "nee"){
      st.push({ key:"sam_low", text:`${n} speelt nu vooral alleen of naast anderen. Samen afstemmen is nog lastig.`, reason:"Samen spelen", suggested:false });
    }

    // Taal in spel
    if(taalF === "altijd" || taalF === "vaak"){
      st.push({ key:"taal_good", text:`${n} gebruikt woorden om mee te doen en het spel of werk te sturen.`, reason:"Taal", suggested:true });
    }else if(taalF === "soms"){
      st.push({ key:"taal_mid", text:`${n} gebruikt soms woorden, en laat ook veel zien met doen en aanwijzen.`, reason:"Taal", suggested:true });
    }else if(taalF === "zelden" || taalF === "nee"){
      st.push({ key:"taal_low", text:`${n} laat vooral met doen zien wat hij of zij bedoelt. Woorden in het spel komen nog op gang.`, reason:"Taal", suggested:false });
    }

    // Afspraken
    if(afsF === "altijd" || afsF === "vaak"){
      st.push({ key:"afs_good", text:`${n} houdt afspraken vaak vast, zoals delen, wachten en opruimen.`, reason:"Afspraken", suggested:true });
    }else if(afsF === "soms"){
      st.push({ key:"afs_mid", text:`${n} houdt afspraken soms goed vast. Soms is er nog herinnering nodig.`, reason:"Afspraken", suggested:true });
    }else if(afsF === "zelden" || afsF === "nee"){
      st.push({ key:"afs_low", text:`${n} heeft nog begeleiding nodig bij afspraken, zoals wachten en delen.`, reason:"Afspraken", suggested:false });
    }

    // Plek specifieke hints, alleen als je ze echt hebt gezien
    if(rolF === "altijd" || rolF === "vaak"){
      st.push({ key:"rol", text:`In de woonhoek zie ik dat ${n} een rol pakt en die even volhoudt.`, reason:"Woonhoek", suggested:false });
    }
    if(bouwF === "altijd" || bouwF === "vaak"){
      st.push({ key:"bouw", text:`In de bouwhoek zie ik dat ${n} bouwt met een idee en dingen probeert als iets niet lukt.`, reason:"Bouwhoek", suggested:false });
    }

    // Werkjes uit de kast
    if(sawWork){
      if(focusF === "altijd" || focusF === "vaak"){
        st.push({ key:"focus_good", text:`Bij werkjes uit de kast blijft ${n} vaak met aandacht bezig. Dat gaat steeds meer vanzelf.`, reason:"Focus", suggested:true });
      }else if(focusF === "soms"){
        st.push({ key:"focus_mid", text:`Bij werkjes uit de kast lukt focus soms goed, en soms is er wat afleiding.`, reason:"Focus", suggested:true });
      }else if(focusF === "zelden" || focusF === "nee"){
        st.push({ key:"focus_low", text:`Bij werkjes uit de kast is focus nog lastig. Dan helpt korte begeleiding.`, reason:"Focus", suggested:false });
      }

      // Afleiding, beschrijvend en feitelijk
      if(afleidF === "altijd" || afleidF === "vaak"){
        st.push({ key:"afl_high", text:`Tijdens werkjes zie ik regelmatig afleiding, zoals rondlopen of kletsen tussendoor.`, reason:"Afleiding", suggested:true });
      }else if(afleidF === "soms"){
        st.push({ key:"afl_mid", text:`Tijdens werkjes is er soms afleiding, dan helpt een klein seintje.`, reason:"Afleiding", suggested:false });
      }

      if(causes.length){
        st.push({ key:"cause", text:`Afleiding lijkt soms te komen door ${causes.join(" en ")}.`, reason:"Afleiding", suggested:false });
      }
      if(help.length){
        st.push({ key:"help", text:`Wat helpt om weer door te gaan is bijvoorbeeld: ${help.join(" en ")}.`, reason:"Wat helpt", suggested:true });
      }
    }

    if(note){
      st.push({ key:"note", text:`Ik zag bijvoorbeeld: ${note}`, reason:"Jouw notitie", suggested:true });
    }

    // Een zachte volgende stap, alleen op basis van je data
    // We kiezen de laagste gemiddelde vaardigheid uit de kern, maar noemen het rustig
    const dims = [
      { key:"init", avg:initAvg, label:"starten en kiezen" },
      { key:"vol", avg:volAvg, label:"volhouden" },
      { key:"sam", avg:samenAvg, label:"samen spelen" },
      { key:"taal", avg:taalAvg, label:"woorden gebruiken in spel" },
      { key:"afs", avg:afsAvg, label:"afspraken vasthouden" }
    ].filter(x => x.avg !== null);

    if(dims.length){
      dims.sort((a,b)=>a.avg-b.avg);
      const g = dims[0];
      st.push({
        key:"next",
        text:`Een volgende stap die nu goed past: ${g.label}. We oefenen dat rustig door in de klas.`,
        reason:"Volgende stap",
        suggested:true
      });
    }

    return st;
  }

  function renderStatements(){
    const p = prefs(currentStudent);
    const list = deriveStatementsForStudent(currentStudent);

    // Voeg eigen stellingen toe als vaste items
    const custom = p.customStatements || [];
    const customItems = custom.map((t, idx)=>({
      key:`custom_${idx}`,
      text:t,
      reason:"Eigen stelling",
      suggested:true
    }));

    const merged = [...list, ...customItems];

    const host = $("statementsWrap");
    host.innerHTML = "";

    // Als er nog geen prefs zijn, zet suggesties standaard aan
    for(const item of merged){
      if(p.starred[item.key] === undefined){
        p.starred[item.key] = !!item.suggested;
      }
    }
    save(data);

    merged.forEach(item=>{
      const row = document.createElement("div");
      row.className = "statement";

      const star = document.createElement("div");
      star.className = "starBtn" + (p.starred[item.key] ? " on" : "");
      star.textContent = p.starred[item.key] ? "★" : "☆";
      star.onclick = ()=>{
        p.starred[item.key] = !p.starred[item.key];
        save(data);
        renderStatements();
      };

      const text = document.createElement("div");
      text.className = "statementText";
      text.textContent = item.text;

      const meta = document.createElement("div");
      meta.className = "statementMeta";
      meta.textContent = item.reason;

      text.appendChild(meta);
      row.appendChild(star);
      row.appendChild(text);

      host.appendChild(row);
    });
  }

  // Rapport teksten bouwen, altijd 3 opties
  function buildTexts(){
    const n = titleCase(currentStudent);
    const p = prefs(currentStudent);
    const items = deriveStatementsForStudent(currentStudent);

    const custom = (p.customStatements || []).map((t, idx)=>({ key:`custom_${idx}`, text:t }));
    const all = [
      ...items.map(x=>({ key:x.key, text:x.text })),
      ...custom
    ];

    const starred = all.filter(x => p.starred && p.starred[x.key]);

    // Als alles uit staat, dan toch iets tonen
    const chosen = starred.length ? starred : all.slice(0, 5);

    // Sorteer in logische volgorde
    const order = [
      "place","init_good","init_mid","init_low",
      "vol_good","vol_mid","vol_low",
      "sam_good","sam_mid","sam_low",
      "taal_good","taal_mid","taal_low",
      "afs_good","afs_mid","afs_low",
      "rol","bouw",
      "focus_good","focus_mid","focus_low",
      "afl_high","afl_mid","cause","help",
      "note",
      "next"
    ];

    const idxOf = (k)=> {
      const i = order.indexOf(k);
      return i === -1 ? 999 : i;
    };

    chosen.sort((a,b)=> idxOf(a.key) - idxOf(b.key));

    // Optie 1: kort, warm, vooral sterk punt en sfeer
    const opt1 = [];
    const add1 = (k)=> { const it = chosen.find(x=>x.key===k); if(it) opt1.push(it.text); };
    add1("place");
    add1("init_good"); add1("vol_good"); add1("sam_good"); add1("taal_good"); add1("afs_good");
    if(opt1.length < 3){
      // vul aan met eerste zinnen
      for(const it of chosen){
        if(opt1.length >= 4) break;
        if(!opt1.includes(it.text)) opt1.push(it.text);
      }
    }
    const t1 = opt1.slice(0,4).join(" ");

    // Optie 2: rustig, wat vollediger, met voorbeeld
    const opt2 = [];
    for(const it of chosen){
      if(opt2.length >= 7) break;
      // liever niet te veel afleiding items in optie 2
      if(["afl_high","afl_mid","cause"].includes(it.key)) continue;
      opt2.push(it.text);
    }
    // voeg note toe als die bestaat
    const note = chosen.find(x=>x.key==="note");
    if(note && !opt2.includes(note.text) && opt2.length < 8) opt2.push(note.text);
    const t2 = opt2.join(" ");

    // Optie 3: meest compleet, inclusief wat helpt en volgende stap
    const opt3 = [];
    for(const it of chosen){
      if(opt3.length >= 10) break;
      opt3.push(it.text);
    }
    // zorg dat next erbij zit
    const next = chosen.find(x=>x.key==="next");
    if(next && !opt3.includes(next.text)) opt3.push(next.text);
    const t3 = opt3.join(" ");

    const out =
      `Optie 1\n${t1}\n\n` +
      `Optie 2\n${t2}\n\n` +
      `Optie 3\n${t3}`;

    $("reportText").textContent = out;
    toast("Teksten gemaakt");
  }

  function addCustomStatement(){
    const txt = ($("customStatement").value || "").trim();
    if(!txt){
      toast("Typ eerst een stelling");
      return;
    }
    const p = prefs(currentStudent);
    p.customStatements.push(txt);
    // Zet nieuwe custom standaard aan
    p.starred[`custom_${p.customStatements.length - 1}`] = true;
    save(data);
    $("customStatement").value = "";
    renderStatements();
    toast("Toegevoegd");
  }

  function exportData(){
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `spelobservaties_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Export gedownload");
  }

  function importData(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(reader.result);
        if(!obj || !obj.students) throw new Error("Geen geldige data");
        data = obj;
        save(data);
        currentStudent = Object.keys(data.students)[0] || STUDENTS[0];
        renderStudentSelect();
        toast("Import gelukt");
        showPlaces();
      }catch(e){
        toast("Import mislukt");
      }
    };
    reader.readAsText(file);
  }

  function deleteStudent(){
    if(!confirm(`Weet je zeker dat je alle data van ${titleCase(currentStudent)} wilt verwijderen`)) return;
    ensureStudent(currentStudent);
    data.students[currentStudent].sessions = [];
    data.students[currentStudent].prefs = { starred:{}, customStatements:[] };
    save(data);
    toast("Data verwijderd");
    renderStudentSelect();
    showOverview();
  }

  function init(){
    renderPlaceButtons();
    renderStudentSelect();
    showPlaces();

    $("studentSelect").addEventListener("change", (e)=>{
      currentStudent = e.target.value;
      renderStudentSelect();
      showPlaces();
    });

    $("btnNew").onclick = ()=> showPlaces();
    $("btnCancel").onclick = ()=> showPlaces();
    $("btnSave").onclick = ()=> saveSession();

    $("btnReport").onclick = ()=> showReport();
    $("btnMakeTexts").onclick = ()=> buildTexts();
    $("btnAddStatement").onclick = ()=> addCustomStatement();

    $("btnCopy").onclick = async ()=>{
      const txt = $("reportText").textContent;
      if(!txt.trim()){
        toast("Maak eerst teksten");
        return;
      }
      try{
        await navigator.clipboard.writeText(txt);
        toast("Gekopieerd");
      }catch(e){
        toast("Kopiëren lukt niet, selecteer en kopieer handmatig");
      }
    };

    $("btnOverview").onclick = ()=> showOverview();
    $("btnDeleteStudent").onclick = ()=> deleteStudent();

    $("btnExport").onclick = ()=> exportData();
    $("btnImport").onclick = ()=> $("importFile").click();
    $("importFile").addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if(f) importData(f);
      e.target.value = "";
    });
  }

  init();
})();
</script>
</body>
</html>